SELECT RIGHT(H.ProjectLocationText,len(H.ProjectLocationText)-8)AS 区域,
       H.HoistingName,
      (SELECT COUNT(*) FROM HoistingPolicy AS H1 WHERE H1.EndDate>=@EndDate AND H1.BeginDate<@EndDate AND H1.IsDeleted=0 AND H1.IsPolicyFileUploaded=1 AND H1.CheckState='PASS'AND (H1.IsRemoved=0 OR H1.IsRemoved IS NULL OR (H1.IsRemoved=1 AND H1.RemoveTime>=@EndDate)) AND H1.ProjectLocationText=H.ProjectLocationText AND H1.HoistingName=H.HoistingName) AS 区域承保设备数,
	  (SELECT COUNT(*) FROM HoistingPolicy AS H1 WHERE H1.BeginDate>=@BeginDate AND H1.BeginDate<@EndDate AND H1.RelatedId IS NULL AND H1.IsDeleted=0 AND H1.IsPolicyFileUploaded=1 AND H1.CheckState='PASS' AND H1.RelatedId IS NULL AND H1.ProjectLocationText=H.ProjectLocationText AND H1.HoistingName=H.HoistingName) AS 区域新增投保数,
	  (SELECT COUNT(*) FROM HoistingPolicy AS H1 WHERE H1.BeginDate>=@BeginDate AND H1.BeginDate<@EndDate AND (H1.IsInstallation IS NULL OR H1.IsInstallation=0) AND H1.IsDeleted=0 AND H1.IsPolicyFileUploaded=1 AND H1.CheckState='PASS' AND H1.RelatedId IS NULL AND H1.ProjectLocationText=H.ProjectLocationText AND H1.HoistingName=H.HoistingName) AS 区域新安装设备,
	  (SELECT COUNT(DISTINCT 保单Id) FROM 检查1 AS JC LEFT JOIN (SELECT T1.HoistingPolicyId AS Id,MIN(InspectionCheckTime2)AS min_check FROM TisInspectionDetailInfo AS D1 LEFT JOIN TisInspectionInfo AS T1 ON T1.Id=D1.TisInspectionInfoId GROUP BY T1.HoistingPolicyId) AS D ON D.Id=JC.保单Id WHERE D.min_check>=@BeginDate AND JC.区域= H.ProjectLocationText AND JC.起重机械=H.HoistingName ) AS 检查台数,
	  (SELECT COUNT(DISTINCT 检查ID) FROM 检查1 AS JC LEFT JOIN (SELECT TisInspectionInfoId AS Id,MIN(InspectionCheckTime2)AS min_check FROM TisInspectionDetailInfo GROUP BY TisInspectionInfoId) AS D ON D.Id=JC.检查ID WHERE D.min_check>=@BeginDate AND JC.区域= H.ProjectLocationText AND JC.起重机械=H.HoistingName ) AS 检查台次,
	  (SELECT COUNT(DISTINCT 检查ID) FROM 检查1 AS JC WHERE JC.rk_台次=1 AND JC.小项风险标识='高风险' AND JC.区域= H.ProjectLocationText AND JC.起重机械=H.HoistingName AND NOT EXISTS(SELECT 1 FROM TisInspectionDetailInfo AS T1 WHERE T1.TisInspectionInfoId=JC.检查ID AND T1.InspectionCheckTime2<@BeginDate AND T1.InspectionResult='高风险')) AS 高风险台次,
	  (SELECT COUNT(DISTINCT 保单ID) FROM 检查1 AS JC WHERE JC.rk_台数=1 AND JC.小项风险标识='高风险' AND JC.区域= H.ProjectLocationText AND JC.起重机械=H.HoistingName AND NOT EXISTS(SELECT 1 FROM TisInspectionDetailInfo AS T1 WHERE T1.TisInspectionInfoId=JC.检查ID AND T1.InspectionCheckTime2<@BeginDate AND T1.InspectionResult='高风险')) AS 高风险台数,
	  (SELECT COUNT(DISTINCT JC.保单ID) FROM 检查2 AS JC 
	          LEFT JOIN (SELECT TisInspectionInfoId AS Id,MIN(InspectionCheckTime2) AS min_check FROM TisInspectionDetailInfo GROUP BY TisInspectionInfoId) AS D ON D.Id=JC.检查ID 
              LEFT JOIN (SELECT JC1.小项风险标识,JC1.保单Id FROM 检查1 AS JC1 WHERE JC1.rk_台数=1 AND JC1.小项风险标识='高风险' AND NOT EXISTS(SELECT 1 FROM TisInspectionDetailInfo AS T1 WHERE T1.TisInspectionInfoId=JC1.检查ID AND T1.InspectionCheckTime2<@BeginDate AND T1.InspectionResult='高风险')) AS D2 ON D2.保单Id=JC.保单Id 
			  LEFT JOIN HoistingPolicy AS H1 ON H1.Id=JC.保单ID
			  WHERE D.min_check>=@BeginDate AND JC.rk_台数=1 AND JC.小项风险标识='高风险' AND JC.区域= H.ProjectLocationText AND JC.起重机械=H.HoistingName AND D2.小项风险标识='高风险' AND (H1.IsRemoved=0 OR H1.IsRemoved IS NULL OR (H1.IsRemoved=1 AND H1.RemoveTime>=@EndDate))) AS 现存高风险台数, 
	  (SELECT COUNT(DISTINCT 保单Id) FROM 检测1 AS JC LEFT JOIN (SELECT InspectionInfoId AS Id,MIN(CreateTime)AS min_check FROM InspectionDetailInfo GROUP BY InspectionInfoId) AS D ON D.Id=JC.检查ID WHERE D.min_check>=@BeginDate AND JC.区域= H.ProjectLocationText AND JC.起重机械=H.HoistingName ) AS 检测台数,
	  (SELECT COUNT(DISTINCT 保单ID) FROM 检测1 AS JC  WHERE JC.rk=1 AND JC.小项检测标识='不合格' AND JC.区域= H.ProjectLocationText AND JC.起重机械=H.HoistingName AND NOT EXISTS(SELECT 1 FROM InspectionDetailInfo AS T1 WHERE T1.InspectionInfoId=JC.检查ID AND T1.CreateTime<@BeginDate AND T1.InspectionResult='不合格')) AS 检测不合格台数,
	  (SELECT COUNT(DISTINCT JC.保单ID) FROM 检测2 AS JC 
	          LEFT JOIN (SELECT InspectionInfoId AS Id,MIN(CreateTime) AS min_check FROM InspectionDetailInfo GROUP BY InspectionInfoId) AS D ON D.Id=JC.检查ID 
              LEFT JOIN (SELECT JC1.小项检测标识,JC1.保单Id FROM 检测1 AS JC1  WHERE JC1.rk=1 AND NOT EXISTS(SELECT 1 FROM InspectionDetailInfo AS T1 WHERE T1.InspectionInfoId=JC1.检查ID AND T1.CreateTime<@BeginDate AND T1.InspectionResult='不合格')) AS D2 ON D2.保单Id=JC.保单Id 
			  LEFT JOIN HoistingPolicy AS H1 ON H1.Id=JC.保单ID
			  WHERE D.min_check>=@BeginDate AND JC.rk=1 AND JC.小项检测标识='不合格' AND JC.区域= H.ProjectLocationText AND JC.起重机械=H.HoistingName AND D2.小项检测标识='不合格' AND (H1.IsRemoved=0 OR H1.IsRemoved IS NULL OR (H1.IsRemoved=1 AND H1.RemoveTime>=@EndDate))) AS 现存检测不合格台数 
FROM HoistingPolicy AS H
WHERE H.ProjectLocationText LIKE '浙江省/宁波市/%' AND H.IsDeleted=0 AND H.IsPolicyFileUploaded=1 AND H.CheckState='PASS'
GROUP BY H.ProjectLocationText,H.HoistingName
ORDER BY H.ProjectLocationText,H.HoistingName;
